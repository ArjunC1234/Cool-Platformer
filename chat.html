<!DOCTYPE html>
<html>
  <head>
    <title>easychat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style> 
      #form {
        position: fixed;
        bottom: 0;
        left: 0;
        display: flex;
        z-index: 2;
      }
      #usnm {
        width: 15vw;
        font-size: 200%;
      }
      #input {
        width: 75vw;
        font-size: 200%;
      }
      button {
        width: 10vw;
        font-size: 200%;
        cursor: pointer;
        background-color: #edbbb4;
        border: 1px solid black;
      }
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #edd2e0;
        font-family: sans-serif;
      }

      .reply {
        background-color: #edd2e0;
        border: 2px solid #baa1a7;
        padding: 5px;
        border-radius: 5px;
        opacity: 80%;
        font-size: 90%
      }
      #messages {
        overflow: auto;
        max-height: 93vh;
        padding: 5px;
      }
      .message {
        background-color: #dbabbe;
        border-radius: 8px;
        padding: 8px;
        max-width: 300px;
        overflow-wrap: break-word;
        cursor: pointer;
      }
      .message:hover {
        box-shadow: inset 0px 0px 2px 1px #baa1a7;
      }
      .brk {
        font-size: 80%;
        font-style: italic;
      }
      #details {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #464d77;
        border-radius: 5px;
        padding: 10px;
        text-align: center;
        color: white;
        overflow: auto;
      }
      a {
        color: inherit;
      }

      @media (max-width: 1000px) {
        button {
          display: none;
        }
        #usnm {
          width: 25vw;
          font-size: 180%;
        }
        #input {
          width: 75vw;
          font-size: 200%;
        }
      }
      @media (max-width: 700px) {
        button {
          display: none;
        }
        #usnm {
          position: fixed;
          top: 20px;
          right: 10px;
          width: 120px;
          font-size: 140%;
        }
        #input {
          width: 100vw;
          font-size: 200%;
        }
        #details {
          display: none;
        }
      }
      #notes{
        position: fixed;
        bottom: 5vh;
        left: 0px;
      }
    </style>
  </head>
  <body onmouseover="changeStatus(true);" onmouseout="changeStatus(false);">
    <div id="details">
      <b>User ID: </b><span id="usnum"></span><br />
      <b>Messages Sent: </b><span id="msnt">0</span><br />
      <!--<b>Online Now</b>
      <p id="onnow"></p>-->
    </div>
    <div id="messages"></div>
    <p id="notes">
      
    </p>
    <form id="form" action="">
      <input
        id="usnm"
        autocomplete="off"
        placeholder="Username..."
        value="Anonymous"
        maxlength="20"
      />
      <input id="input" autocomplete="off" maxlength="500" /><button>
        Send
      </button>
    </form>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
      Notification.requestPermission().then(function(result) {
        console.log(result);
      });
      var i = 0;
      var pageStatus = true;

      function changeStatus(status) {
        i += 1;
        if (status == true) {
          pageStatus = true;
          /* change the users status to active */
        } else {
          pageStatus = false;
          window.setTimeout(function() {
            if (pageStatus == false) {
              console.log(
                i + " Page is inactive"
              ); /* change the users status to inactive */
            }
          }, 1000);
        }
      }
      var on = 0;
      var unum = Math.floor(Math.random() * 100000);
      document.getElementById("usnum").innerHTML = unum;
      var msnt = 0;
      var socket = io();
      var mess = "";
      var messages = document.getElementById("messages");
      var form = document.getElementById("form");
      var input = document.getElementById("input");

      async function rpl(txt) {
        mess = '<div class="reply">' + txt + "</div>";
        document.getElementById('notes').innerHTML = 'Replying to message: <i>' + txt + '</i>';
        await sleep(2000);
        document.getElementById('notes').innerHTML = '';
      }

      form.addEventListener("submit", function(e) {
        e.preventDefault();
        if (input.value) {
          var usid = document.getElementById("usnm").value + "-" + unum;
          if(mess==""){
          socket.emit(
            "chat message",
            usid + ": " + input.value + "⠀" + window.location.pathname
          );
          }else{
          socket.emit(
            "chat message",
            mess.split("⠀")[0] + usid + ": " + input.value + "⠀" + window.location.pathname 
          );
            
          }
          input.value = "";
          msnt++;
          document.getElementById("msnt").innerHTML = msnt;
        }
      });
      socket.on("connection", function(txt) {
        if (txt.split(",")[1] == window.location.pathname) {
          document.getElementById("messages").innerHTML +=
            "<center>" + txt.split(",")[0] + "</center><br><br>";
          document.getElementById("messages").scrollTo({
            top: document.getElementById("messages").scrollHeight,
            left: 0,
            behavior: "smooth"
          });
        }
      });
      socket.on("chat message", function(msg) {
        if (msg.split("⠀")[1] == window.location.pathname) {
          if (!pageStatus) {
            var notification = new Notification("new easychat message", {
              body: msg.split("⠀")[0]
            });
          }
          mess = msg
            .replace(/\*(.*?)\*/gims, "<b>$1</b>")
            .replace(/\_(.*?)\_/gims, "<i>$1</i>")
            .replace(/\|(.*?)\|/gims, '<div class="reply">$1</div>');
          var today = new Date();
          var min = today.getMinutes();
          var sec = today.getSeconds();
          if (min < 10) {
            min = "0" + min;
          }
          if (sec < 10) {
            sec = "0" + sec;
          }
          var time = today.getHours() + ":" + min + ":" + sec;
          document.getElementById("messages").innerHTML +=
            '<div class="message" onclick="rpl(this.innerHTML)" alt="Reply to this message" role="img">' +
            mess.split("⠀")[0] +
            '</div><div class="brk">' +
            time +
            "</div><br>";
          document.getElementById("messages").scrollTo({
            top: document.getElementById("messages").scrollHeight,
            left: 0,
            behavior: "smooth"
          });
          mess = "";
        }
      });
      var online = [];

      socket.on("online", function(usidm) {
        if (online.indexOf(usidm.split("⠀")[0]) == -1) {
          online.push(usidm.split("⠀")[0]);
        }
      });
      async function onlinenow() {
        var usid = document.getElementById("usnm").value + "-" + unum;
        socket.emit("online", usid + "⠀" + window.location.pathname);
        var str = "";
        /*for (var p = 0; p < online.length; p++) {
          if (online[p].indexOf(usid)) {
            online.splice(online.indexOf(usid), 1);
          }
        }*/
        for (var j = 0; j < online.length; j++) {
          str += usid + "<br>";
        }
        //document.getElementById("onnow").innerHTML = ''
        //document.getElementById("onnow").innerHTML = str;
        await sleep(200);
        onlinenow();
      }
      //onlinenow();
    </script>
  </body>
</html>
